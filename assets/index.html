<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="app.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vehicle Counter</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>

<div id="app">
  <!-- Auth (Login / Register) -->
  <div v-if="route === 'login' || route === 'register'" class="auth-layout">
    <div class="auth-curve-banner">
      <div class="auth-brand">
        <img src="https://cdn-icons-png.flaticon.com/512/776/776588.png" alt="Vehicle" class="auth-vehicle-icon">
        <h1>Vehicle Counter</h1>
      </div>
    </div>
    <div class="auth-card">
      <!-- LOGIN FORM -->
      <div v-if="route === 'login'" class="auth-form">
        <input type="text" placeholder="Username" v-model.trim="username">
        <input type="password" placeholder="Password" v-model="password">
        <button class="auth-submit" @click="login">Login</button>
        <p class="switch-auth">
          Don't have an account?
          <button class="link-button" @click="goToRegister"><a href="#register">Register</a></button>
        </p>
      </div>

      <!-- REGISTER FORM -->
      <div v-else class="auth-form">
        <input type="text" placeholder="Username" v-model.trim="username">
        <input type="password" placeholder="Password" v-model="password">
        <p class="password-hint" :class="passwordStrengthClass" v-if="password">
          Strength: {{ passwordStrength }}
        </p>
        <input type="password" placeholder="Confirm Password" v-model="confirmpassword">
        <p class="password-confirm-hint" :class="confirmPasswordClass" v-if="confirmpassword">
          {{ confirmPasswordMessage }}
        </p>

        <div class="otp">
          <input type="text" placeholder="Contact Number" v-model.trim="contactnumber">
          <input type="text" placeholder="OTP" v-model.trim="enteredOtp">
          <button class="sendOTPbutton" @click="sendOtp">Send</button>
        </div>

        <button class="auth-submit" @click="register">Register</button>
        <p class="switch-auth">
          Already have an account?
          <button class="link-button" @click="goToLogin"><a href="#login">Login</a></button>
        </p>
      </div>

      <p class="error" v-if="errorMessage">{{ errorMessage }}</p>
      <p class="success" v-if="successMessage">{{ successMessage }}</p>
    </div>
  </div>

  <!-- App (Dashboard/Summary) -->
  <div v-else class="app-layout">
    <header class="dashboard-header">
      <div class="dashboard-curve-banner">
        <div class="dashboard-brand">
          <img src="https://cdn-icons-png.flaticon.com/512/776/776588.png" alt="Vehicle" class="dashboard-vehicle-icon">
          <h1>Vehicle Counter</h1>
        </div>
        <nav class="dashboard-nav">
          <a href="#dashboard" class="dashboard-nav-link" :class="{ active: route === 'dashboard' }">Home</a>
          <a href="#summary" class="dashboard-nav-link" :class="{ active: route === 'summary' }">Summary</a>
          <button class="dashboard-logout" @click="logout">Logout</button>
        </nav>
      </div>
    </header>

    <!-- Dashboard -->
    <div v-if="route === 'dashboard'">
      <h1 class="content">Dashboard</h1>

      <div class="card-container">
        <div class="vehicle-card" v-for="v in vehicleCards" :key="v.key">
          <img :src="v.img" :alt="v.label">
          <div class="counter">
            <p>{{ v.label }}</p>
            <h2>{{ vehicles[v.key] ?? 0 }}</h2>
            <button @click="increment(v.key, +1)">+</button>
            <button @click="increment(v.key, -1)" :disabled="(vehicles[v.key] ?? 0) === 0">−</button>
          </div>
        </div>

        <div class="vehicle-card add-vehicle-card">
          <div class="counter">
            <p>Add Vehicle</p>
            <button @click="openVehicleModal">＋</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Summary -->
    <div v-else-if="route === 'summary'">
      <h1 class="content">Vehicle Summary</h1>

      <div class="summary-content">
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Truck</th>
              <th>Motorcycle</th>
              <th>Tricycle</th>
              <th>Pedicab</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="userData in allUsersVehicleData" :key="userData.username">
              <td>{{ userData.username }}</td>
              <td>{{ userData.truck || 0 }}</td>
              <td>{{ userData.motorcycle || 0 }}</td>
              <td>{{ userData.tricycle || 0 }}</td>
              <td>{{ userData.pedicab || 0 }}</td>
            </tr>
            <tr class="total-row">
              <td><strong>Total</strong></td>
              <td><strong>{{ totalVehicles.truck }}</strong></td>
              <td><strong>{{ totalVehicles.motorcycle }}</strong></td>
              <td><strong>{{ totalVehicles.tricycle }}</strong></td>
              <td><strong>{{ totalVehicles.pedicab }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add Vehicle Modal (pop-up) -->
  <div v-if="showVehicleModal" class="modal-backdrop" @click.self="closeVehicleModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Add Vehicle</h2>
        <button type="button" class="modal-close" @click="closeVehicleModal" aria-label="Close">&times;</button>
      </div>
      <label>
        Vehicle name
        <input type="text" v-model.trim="newVehicleName" placeholder="e.g. Bus">
      </label>
      <label>
        Type
        <select v-model="newVehicleType">
          <option value="">Select type</option>
          <option value="truck">Truck</option>
          <option value="motorcycle">Motorcycle</option>
          <option value="tricycle">Tricycle</option>
          <option value="pedicab">Pedicab</option>
          <option value="other">Other</option>
        </select>
      </label>
      <div class="modal-actions">
        <button @click="confirmAddVehicle">Add</button>
        <button @click="closeVehicleModal">Cancel</button>
      </div>
      <p class="error" v-if="modalError">{{ modalError }}</p>
    </div>
  </div>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      // Simple "router" using the URL hash:
      // - #login, #register, #dashboard, #summary
      route: "login",

      // Register form fields
      username: "",
      password: "",
      confirmpassword: "",
      contactnumber: "",

      // OTP is demo-only (shown in alert)
      otp: null,          // generated OTP
      enteredOtp: null,   // OTP entered by user

      // UI messages for validation feedback
      errorMessage: "",
      successMessage: "",

      // Stored users (demo-only storage in localStorage)
      users: JSON.parse(localStorage.getItem("users")) || [],

      // "Session" for this demo: if present, user is considered logged in
      currentUser: localStorage.getItem("currentUser") || "",

      // Vehicle counts (auto-saved to localStorage as "vehiclesData")
      vehicles: {
        truck: 0,
        motorcycle: 0,
        tricycle: 0,
        pedicab: 0
      },

      // Add-vehicle modal state
      showVehicleModal: false,
      newVehicleName: "",
      newVehicleType: "",
      modalError: ""
    };
  },
  computed: {
    isLoggedIn() {
      // Any non-empty currentUser means "logged in"
      return !!this.currentUser;
    },
    passwordStrength() {
      const pwd = this.password || "";
      const lengthScore = pwd.length;
      const hasLetters = /[A-Za-z]/.test(pwd);
      const hasNumbers = /\d/.test(pwd);
      const hasSpecial = /[^A-Za-z0-9]/.test(pwd);

      if (!pwd) return "";

      if (lengthScore < 8 || !hasLetters || !hasNumbers) {
        return "Weak (use at least 8 characters, letters and numbers)";
      }

      if (lengthScore >= 8 && lengthScore < 10 && hasLetters && hasNumbers && !hasSpecial) {
        return "Medium (good, but add more length or a special character to make it stronger)";
      }

      if (lengthScore >= 10 && hasLetters && hasNumbers && hasSpecial) {
        return "Strong";
      }

      return "Medium";
    },
    passwordStrengthClass() {
      const text = this.passwordStrength || "";
      if (!text) return "";
      if (text.startsWith("Weak")) return "password-weak";
      if (text.startsWith("Medium")) return "password-medium";
      if (text.startsWith("Strong")) return "password-strong";
      return "";
    },
    confirmPasswordMessage() {
      if (!this.confirmpassword) return "";
      return this.password === this.confirmpassword ? "Password match" : "Password didn't match";
    },
    confirmPasswordClass() {
      if (!this.confirmpassword) return "";
      return this.password === this.confirmpassword ? "password-match" : "password-mismatch";
    },
    vehicleCards() {
      // Default vehicle cards + metadata (labels/images).
      // Any extra vehicles added by the user will also show up.
      const knownMeta = [
        {
          key: "truck",
          label: "Truck",
          img: "https://assets-v2.lottiefiles.com/a/13d20d82-116b-11ee-8327-bf0f670c5933/UnKFqiCVck.gif"
        },
        {
          key: "motorcycle",
          label: "Motorcycle",
          img: "https://cdn.dribbble.com/userupload/21376896/file/original-db00ef235443c282045c0e473a5cb689.gif"
        },
        {
          key: "tricycle",
          label: "Tricycle",
          img: "https://i.pinimg.com/originals/6b/7e/92/6b7e9220cd03991423faf5c515c29bd8.gif"
        },
        {
          key: "pedicab",
          label: "Pedicab",
          img: "assets/pedicab.png"
        }
      ];

      const knownKeys = new Set(knownMeta.map(m => m.key));
      const extraKeys = Object.keys(this.vehicles || {}).filter(k => !knownKeys.has(k));

      // For user-added vehicles we use a fallback image
      const extraMeta = extraKeys.map(k => ({
        key: k,
        label: k.charAt(0).toUpperCase() + k.slice(1),
        img: "assets/truck.png"
      }));

      return [...knownMeta, ...extraMeta];
    },
    allUsersVehicleData() {
      // Get vehicle data for all users
      return this.users.map(user => {
        const key = this.userVehiclesKey(user.username);
        const stored = localStorage.getItem(key);
        let storedVehicles = {
          truck: 0,
          motorcycle: 0,
          tricycle: 0,
          pedicab: 0
        };
        if (stored) {
          try {
            storedVehicles = JSON.parse(stored) || storedVehicles;
          } catch (e) {
            // If parsing fails, use defaults
          }
        }
        return {
          username: user.username,
          truck: storedVehicles.truck || 0,
          motorcycle: storedVehicles.motorcycle || 0,
          tricycle: storedVehicles.tricycle || 0,
          pedicab: storedVehicles.pedicab || 0
        };
      });
    },
    totalVehicles() {
      // Calculate totals across all users
      const totals = {
        truck: 0,
        motorcycle: 0,
        tricycle: 0,
        pedicab: 0
      };
      
      this.allUsersVehicleData.forEach(userData => {
        totals.truck += userData.truck || 0;
        totals.motorcycle += userData.motorcycle || 0;
        totals.tricycle += userData.tricycle || 0;
        totals.pedicab += userData.pedicab || 0;
      });
      
      return totals;
    }
  },
  mounted() {
    // Decide initial route based on login status
    if (this.isLoggedIn) {
      this.route = "dashboard";
    } else {
      this.route = "login";
    }

    // Load vehicle counts for the current user
    this.loadVehiclesForCurrentUser();

    // Keep `route` synced with URL hash and guard protected pages
    const syncRouteFromHash = () => {
      const hash = (window.location.hash || "").replace("#", "");
      const allowed = new Set(["login", "register", "dashboard", "summary"]);
      const desiredRaw = hash || (this.isLoggedIn ? "dashboard" : "login");
      const desired = allowed.has(desiredRaw) ? desiredRaw : (this.isLoggedIn ? "dashboard" : "login");
      this.route = desired;

      // Guard: must be logged in to view dashboard/summary
      if (!this.isLoggedIn && (this.route === "dashboard" || this.route === "summary")) {
        this.route = "login";
        window.location.hash = "#login";
      }
    };

    window.addEventListener("hashchange", syncRouteFromHash);
    syncRouteFromHash();
  },
  methods: {
    userVehiclesKey(username) {
      return `vehiclesData_${username}`;
    },
    loadVehiclesForCurrentUser() {
      if (!this.currentUser) {
        // default blank vehicles if no user
        this.vehicles = {
          truck: 0,
          motorcycle: 0,
          tricycle: 0,
          pedicab: 0
        };
        return;
      }
      const key = this.userVehiclesKey(this.currentUser);
      const storedVehicles = JSON.parse(localStorage.getItem(key));
      if (storedVehicles && typeof storedVehicles === "object") {
        this.vehicles = storedVehicles;
      } else {
        this.vehicles = {
          truck: 0,
          motorcycle: 0,
          tricycle: 0,
          pedicab: 0
        };
      }
    },
    sendOtp() {
      // Demo OTP sender (no SMS integration)
      if (!this.contactnumber || this.contactnumber.toString().length !== 10) {
        this.errorMessage = "Enter a valid 10-digit contact number";
        return;
      }
      // Generate random 4-digit OTP
      this.otp = Math.floor(1000 + Math.random() * 9000);
      alert("Your OTP is: " + this.otp); // demo only
      this.successMessage = "OTP sent! Check alert box.";
      this.errorMessage = "";
    },
    goToLogin() {
      this.errorMessage = "";
      this.successMessage = "";
      this.password = "";
      this.confirmpassword = "";
      this.enteredOtp = null;
      this.route = "login";
      window.location.hash = "#login";
    },
    goToRegister() {
      this.errorMessage = "";
      this.successMessage = "";
      this.password = "";
      this.confirmpassword = "";
      this.enteredOtp = null;
      this.route = "register";
      window.location.hash = "#register";
    },
    login() {
      this.errorMessage = "";
      this.successMessage = "";

      if (!this.username || !this.password) {
        this.errorMessage = "Username and password are required";
        return;
      }

      const user = this.users.find(
        u => u.username === this.username && u.password === this.password
      );

      if (!user) {
        this.errorMessage = "Invalid username or password";
        return;
      }

      this.currentUser = user.username;
      localStorage.setItem("currentUser", this.currentUser);
      this.loadVehiclesForCurrentUser();
      this.successMessage = "Login successful!";
      setTimeout(() => {
        window.location.hash = "#dashboard";
      }, 500);
    },
    register() {
      // Register + "log in" the user
      this.errorMessage = "";
      this.successMessage = "";

      // Basic validation
      if (!this.username || !this.password || !this.confirmpassword || !this.contactnumber || !this.enteredOtp) {
        this.errorMessage = "All fields are required";
        return;
      }
      // Username validation: minimum 5 letters
      if (this.username.length < 5 || !/^[A-Za-z]+$/.test(this.username)) {
        this.errorMessage = "Username must be at least 5 letters and contain only letters (A–Z)";
        return;
      }
      // Password validation: at least 8 chars, alphanumeric
      const hasLetters = /[A-Za-z]/.test(this.password);
      const hasNumbers = /\d/.test(this.password);
      if (this.password.length < 8 || !hasLetters || !hasNumbers) {
        this.errorMessage = "Password is too weak. It must be at least 8 characters and contain both letters and numbers.";
        return;
      }
      if (this.password !== this.confirmpassword) {
        this.errorMessage = "Passwords do not match";
        return;
      }
      // Contact number validation: 10 digits, starting with 9 (for +63 9XXXXXXXXX format)
      const contactStr = this.contactnumber.toString();
      if (contactStr.length !== 10 || !/^\d+$/.test(contactStr)) {
        this.errorMessage = "Invalid contact number. It must be 10 digits.";
        return;
      }
      if (!contactStr.startsWith("9")) {
        this.errorMessage = "Invalid contact number. In +63 format it should start with 9 (e.g. 9XXXXXXXXX).";
        return;
      }
      if (parseInt(this.enteredOtp) !== this.otp) {
        this.errorMessage = "Incorrect OTP";
        return;
      }
      // Check if username exists
      const exists = this.users.find(u => u.username === this.username);
      if (exists) {
        this.errorMessage = "Username already exists";
        return;
      }
      // Save user
      this.users.push({ username: this.username, password: this.password });
      localStorage.setItem("users", JSON.stringify(this.users));
      this.currentUser = this.username;
      localStorage.setItem("currentUser", this.currentUser);
       // Create a fresh vehicle set for this new user
      this.loadVehiclesForCurrentUser();
      this.successMessage = "Registered successfully!";
      setTimeout(() => {
        // Navigate to dashboard inside the single-page app
        window.location.hash = "#dashboard";
      }, 1000); 
      
    },
    logout() {
      // End demo session and return to register screen
      localStorage.removeItem("currentUser");
      this.currentUser = "";
      this.route = "login";
      window.location.hash = "#login";
    },
    increment(vehicleKey, delta) {
      // Increase/decrease count, never below 0
      const current = Number(this.vehicles[vehicleKey] ?? 0);
      const next = Math.max(0, current + delta);
      this.vehicles[vehicleKey] = next;
    },
    openVehicleModal() {
      this.newVehicleName = "";
      this.newVehicleType = "";
      this.modalError = "";
      this.showVehicleModal = true;
    },
    closeVehicleModal() {
      this.showVehicleModal = false;
    },
    confirmAddVehicle() {
      this.modalError = "";
      const vehicleNameRaw = this.newVehicleName;

      if (!vehicleNameRaw) {
        this.modalError = "Vehicle name is required";
        return;
      }

      // Normalize input into a safe key: lowercase, underscores, alphanumerics only
      const key = vehicleNameRaw
        .trim()
        .toLowerCase()
        .replace(/\s+/g, "_")
        .replace(/[^a-z0-9_]/g, "");

      if (!key) {
        this.modalError = "Vehicle name is invalid";
        return;
      }

      if (Object.prototype.hasOwnProperty.call(this.vehicles, key)) {
        this.modalError = "That vehicle already exists.";
        return;
      }

      this.vehicles[key] = 0;
      this.showVehicleModal = false;
    },
    saveVehicles() {
      // Persist counts so summary/dashboard stay in sync across refreshes
      if (!this.currentUser) return;
      const key = this.userVehiclesKey(this.currentUser);
      localStorage.setItem(key, JSON.stringify(this.vehicles));
    },
    refreshUsers() {
      // Refresh users array from localStorage to ensure it's up to date
      const storedUsers = JSON.parse(localStorage.getItem("users")) || [];
      this.users = storedUsers;
    }
  },
  watch: {
    vehicles: {
      deep: true,
      handler() {
        // Auto-save whenever any vehicle count changes
        this.saveVehicles();
      }
    },
    currentUser() {
      this.loadVehiclesForCurrentUser();
    },
    route(newRoute) {
      // Refresh users when navigating to summary page to show latest data
      if (newRoute === "summary") {
        this.refreshUsers();
      }
    }
  }
}).mount("#app");
</script>

</body>
</html>